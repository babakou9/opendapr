---
output: github_document
always_allow_html: yes
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
require(magrittr)
require(opendapr)
```
# opendapr <img src="man/figures/logo.png" align="right" />

<!-- badges: start -->
[![licence](https://img.shields.io/badge/Licence-GPL--3-blue.svg)](https://www.r-project.org/Licenses/GPL-3)
[![Travis build status](https://travis-ci.org/ptaconet/opendapr.svg?branch=master)](https://travis-ci.org/ptaconet/opendapr)
<!-- badges: end -->

**[ Caution : Package still in development ... ]**

The goal of opendapr is to ...

## Installation

You can install the released version of opendapr from [CRAN](https://CRAN.R-project.org) with:

``` r
install.packages("opendapr")
```

And the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("ptaconet/opendapr")
```

`opendapr` is not a generic wrapper around the OPeNDAP framework. Its objective is more to provide an entry point to some specific OPeNDAP servers (e.g. MODIS, VNP, GPM, SMAP)

## Which products are available for download through `opendapr` ?

The collections currently available for download are listed above. The function `get_collections_available()` returns that same table. Want more details on a specific collection ? Click on the `DOI` column of the table above !

<details><summary>Products available for download with opendapr (click to expand)</summary>
<p>

```{r, eval = TRUE, echo=F}
library(kableExtra)
get_collections_available()[c("collection","long_name","source","DOI","url_opendapserver")] %>%
  kable() %>%
  kable_styling()
```

</p>
</details>

## Example

We want to download over the 50 km x 50 km (3500 km^2^) wide region of interest :

- a 40 days time series of [MODIS Terra Land Surface Temperature (LST)](https://dx.doi.org/10.5067/MODIS/MOD11A1.006) (spatial resolution : 1 km ; temporal resolution : 1 day),
- the same 40 days times series of [Global Precipitation Measurement (GPM)](https://doi.org/10.5067/GPM/IMERGDF/DAY/06) (spatial resolution : 1Â° ; temporal resolution : 1 day)

First prepare the script : set-up ROI, time frame and login to USGS ERS

```{r example_prepare, eval = FALSE}
### Prepare script
# Packages
require(opendapr)
require(sf)

# Set ROI and time range of interest
roi <- st_read(system.file("extdata/roi_example.gpkg", package = "opendapr"),quiet=TRUE)
time_range <- as.Date(c("2017-01-01","2017-01-30"))

# Login to USGS servers with username and password. To create an account : https://ers.cr.usgs.gov/register/
credentials_usgs <- config::get("usgs")
log <- login_usgs(c(credentials_usgs$usr,credentials_usgs$pwd))
```

Download MODIS and GPM data in two steps : i) get the OPeNDAP URLs with the `get_url()` function and ii) download the data with the `download_data()` function.

```{r example_modis, eval = FALSE}
## Get the URLs for MOD11A1.006
urls_mod11a1 <- get_url(
  collection = "MOD11A1.006",
  roi = roi,
  time_range = time_range
 )

## Get the URLs for GPM_L3/GPM_3IMERGDF.06
urls_gpm <- get_url(
  collection = "GPM_L3/GPM_3IMERGDF.06",
  roi = roi,
  time_range = time_range
 )

## Download the data. Destination file for each dataset is specified in the column "destfile" of the dataframe urls_mod11a1 and urls_gpm
df_to_dl <- rbind(urls_mod11a1,urls_gpm)
res_dl <- download_data(df_to_dl,data_source="usgs",parallel = TRUE)

## Check that data have been properly downloaded :
list.files(res_dl$destile)
```

It is also possible to subset the bands to download with the parameter `variables` of the function `get_url()`.

To further import the data in R, have a look at the [last section of the Readme](#important-note-import) and / or the [dedicated section in the vignettes](https://ptaconet.github.io/opendapr/articles/simple_workflow.html#import) ! 

Simple or more complex data download + import workflows are provided in the vignettes [here](https://ptaconet.github.io/opendapr/articles/simple_workflow.html) or [there]().


## Important note regarding the further import of the data in R {#important-note-import}

Various packages and related classes can be used to read the data downloaded through OPeNDAP. In any case, care must be taken when importing data that was downloaded through OPeNDAP. Depending on the collection, some "issues" were raised. These issues are independant from `opendapr` : they result most of time of a kind of lack of full implementation of the OPeNDAP framework by the data providers. These issues are :

- for MODIS and VNP collections : CRS has to be provided
- for GPM collections :  CRS has to be provided + data have to be flipped
- for SMAP collections :information on the bounding coordinates of the data have to be provided

These issues can easily be dealt at the import phase in R. The functions below includes the manipulations that have to be done at the data import phase ("path.to.nc4" is the path to a dataset downloaded with `opendapr` and "variable.of.interest" is the name of a variable).

```{r function_to_import_modis_vnp, eval=F }
#################### 
#To import as a raster object a single variable of a MODIS or VNP product (with the raster package) : 
rast_modis_vnp <- raster(path="path.to.nc4",varname="variable.of.interest",crs="+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +a=6371007.181 +b=6371007.181 +units=m +no_defs")
####################
```

```{r function_to_import_gpm, eval=F }
#################### 
#To import as a raster object a single variable of a GPM product (with the raster package) : 
rast_gpm <- raster(path="path.to.nc4",varname="variable.of.interest",crs="+init=epsg:4326 +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0") %>%
  t() %>%
  flip("y") %>%
  flip("x")
####################
```

```{r function_to_import_smap, eval=F }
#################### 
#To import as a raster object a single variable of a SMAP product (with the raster and ncdf4 package) : 
smap_sp_bound <- opendapr::get_optional_parameters(roi = roi, collection = "SMAP/SPL3SMP_E.003")$roiSpatialBound$`1`
  
rast_smap <- ncdf4::nc_open("path.to.nc4")) %>%
  ncdf4::ncvar_get("variable.of.interest")) %>%
  raster(t(.), ymn=smap_sp_bound[1], ymx=smap_sp_bound[2], xmn=smap_sp_bound[3], xmx=smap_sp_bound[4], crs="+proj=cea +lon_0=0 +lat_ts=30 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0") # EPSG : 6933
####################
```
